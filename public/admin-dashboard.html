<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - College Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 20px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 20px;
        }

        .sidebar-header h2 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 12px;
            opacity: 0.8;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin: 0;
        }

        .sidebar-menu a {
            display: block;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            transition: background 0.2s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: white;
        }

        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 30px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .top-bar h1 {
            font-size: 24px;
            color: #333;
        }

        .logout-btn {
            padding: 10px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: #c0392b;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .content-section {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h2 {
            font-size: 20px;
            color: #333;
        }

        .btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #764ba2;
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table thead {
            background: #f8f9fa;
        }

        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        table th {
            font-weight: 600;
            color: #333;
        }

        table tr:hover {
            background: #f9f9f9;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 20px;
            color: #333;
        }

        .close-btn {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .success-message,
        .error-message {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .success-message {
            background: #d5f4e6;
            color: #27ae60;
        }

        .error-message {
            background: #fadbd8;
            color: #e74c3c;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-buttons button {
            padding: 6px 12px;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                padding: 15px 0;
            }

            .main-content {
                margin-left: 0;
                padding: 15px;
            }

            .stats-container {
                grid-template-columns: 1fr;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            table {
                font-size: 12px;
            }

            table th,
            table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>College Management</h2>
                <p id="adminName">Admin</p>
            </div>
            <ul class="sidebar-menu">
                <li><a class="menu-item active" data-section="dashboard">Dashboard</a></li>
                <li><a class="menu-item" data-section="staff">Staff Management</a></li>
                <li><a class="menu-item" data-section="classroom">Classroom Management</a></li>
                <li><a class="menu-item" data-section="timetable">Timetable Management</a></li>
                <li><a class="menu-item" data-section="leave-approval">Leave Approvals</a></li>
                <li><a class="menu-item" data-section="rescheduling">Class Rescheduling</a></li>
                <li><a class="menu-item" data-section="attendance">Attendance & Presence</a></li>
                <li><a class="menu-item" data-section="activity">Login Activity</a></li>
                <li><a onclick="logout()" style="cursor: pointer;">Logout</a></li>
            </ul>
        </div>

        <div class="main-content">
            <div class="top-bar">
                <h1 id="pageTitle">Dashboard</h1>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <div class="stats-container">
                    <div class="stat-card">
                        <h3>Total Staff</h3>
                        <div class="number" id="totalStaffCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Currently Logged In</h3>
                        <div class="number" id="activeStaffCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Pending Leave Requests</h3>
                        <div class="number" id="pendingLeaveCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Classes Rescheduled</h3>
                        <div class="number" id="rescheduledCount">0</div>
                    </div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px;">Recent Login Activity</h3>
                <table id="activityTable">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Type</th>
                            <th>Login Time</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="activityBody">
                    </tbody>
                </table>
            </div>

            <!-- Staff Management Section -->
            <div id="staff" class="content-section">
                <div class="section-header">
                    <h2>Staff Management</h2>
                    <button class="btn" onclick="openAddStaffModal()">Add Staff Member</button>
                </div>
                <div id="staffMessage"></div>
                <table id="staffTable">
                    <thead>
                        <tr>
                            <th>Employee ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Department</th>
                            <th>Position</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="staffBody">
                    </tbody>
                </table>
            </div>

            <!-- Classroom Management Section -->
            <div id="classroom" class="content-section">
                <div class="section-header">
                    <h2>Classroom Management</h2>
                    <button class="btn" onclick="openAddClassroomModal()">Add Classroom</button>
                </div>
                <div id="classroomMessage"></div>
                <table id="classroomTable">
                    <thead>
                        <tr>
                            <th>Room Number</th>
                            <th>Room Name</th>
                            <th>Capacity</th>
                            <th>Building</th>
                            <th>Floor</th>
                            <th>Facilities</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="classroomBody">
                    </tbody>
                </table>
            </div>

            <!-- Timetable Management Section -->
            <div id="timetable" class="content-section">
                <div class="section-header">
                    <h2>Timetable Management</h2>
                    <button class="btn" onclick="openAddTimetableModal()">Add Class Schedule</button>
                </div>
                <div id="timetableMessage"></div>
                <table id="timetableTable">
                    <thead>
                        <tr>
                            <th>Staff Name</th>
                            <th>Course Code</th>
                            <th>Course Name</th>
                            <th>Day</th>
                            <th>Time Slot</th>
                            <th>Room</th>
                            <th>Batch</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="timetableBody">
                    </tbody>
                </table>
            </div>

            <!-- Leave Approval Section -->
            <div id="leave-approval" class="content-section">
                <div class="section-header">
                    <h2>Leave Approvals</h2>
                </div>
                <div id="leaveMessage"></div>
                <table id="leaveTable">
                    <thead>
                        <tr>
                            <th>Staff Name</th>
                            <th>Leave Date</th>
                            <th>Type</th>
                            <th>Reason</th>
                            <th>Applied On</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="leaveBody">
                    </tbody>
                </table>
            </div>

            <!-- Class Rescheduling Section -->
            <div id="rescheduling" class="content-section">
                <div class="section-header">
                    <h2>Class Rescheduling</h2>
                </div>
                <div id="rescheduleMessage"></div>
                <table id="rescheduleTable">
                    <thead>
                        <tr>
                            <th>Original Staff</th>
                            <th>Assigned Staff</th>
                            <th>Course</th>
                            <th>Reason</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="rescheduleBody">
                    </tbody>
                </table>
            </div>

            <!-- Attendance & Presence Section -->
            <div id="attendance" class="content-section">
                <div class="section-header">
                    <h2>Attendance & Presence</h2>
                </div>
                <div id="attendanceMessage"></div>
                <div class="form-group">
                    <label>Filter by Staff Member</label>
                    <select id="staffFilter" onchange="loadAttendanceReport()">
                        <option value="">All Staff</option>
                    </select>
                </div>
                <table id="attendanceTable">
                    <thead>
                        <tr>
                            <th>Staff Name</th>
                            <th>Leave Date</th>
                            <th>Leave Type</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceBody">
                    </tbody>
                </table>
            </div>

            <!-- Login Activity Section -->
            <div id="activity" class="content-section">
                <div class="section-header">
                    <h2>Login Activity Log</h2>
                </div>
                <table id="activityLogTable">
                    <thead>
                        <tr>
                            <th>User Name</th>
                            <th>User Type</th>
                            <th>Login Time</th>
                            <th>Logout Time</th>
                            <th>IP Address</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="activityLogBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add/Edit Staff Modal -->
    <div id="staffModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Staff Member</h3>
                <span class="close-btn" onclick="closeStaffModal()">&times;</span>
            </div>
            <form id="staffForm" onsubmit="submitStaffForm(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Employee ID</label>
                        <input type="text" id="staffEmployeeId" required>
                    </div>
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="staffName" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="staffEmail" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Department</label>
                        <!-- Changed from text input to dropdown select -->
                        <select id="staffDepartment" required>
                            <option value="">Select Department</option>
                            <option value="Computer Science">Computer Science</option>
                            <option value="Mechanical Engineering">Mechanical Engineering</option>
                            <option value="Civil Engineering">Civil Engineering</option>
                            <option value="Electrical Engineering">Electrical Engineering</option>
                            <option value="Electronics Engineering">Electronics Engineering</option>
                            <option value="Information Technology">Information Technology</option>
                            <option value="Mathematics">Mathematics</option>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="English">English</option>
                            <option value="Business Studies">Business Studies</option>
                            <option value="Administration">Administration</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Position</label>
                        <!-- Changed from text input to dropdown select -->
                        <select id="staffPosition" required>
                            <option value="">Select Position</option>
                            <option value="Professor">Professor</option>
                            <option value="Associate Professor">Associate Professor</option>
                            <option value="Assistant Professor">Assistant Professor</option>
                            <option value="Lecturer">Lecturer</option>
                            <option value="Lab Assistant">Lab Assistant</option>
                            <option value="Teaching Assistant">Teaching Assistant</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Phone (Optional)</label>
                    <input type="text" id="staffPhone">
                </div>
                <div class="form-group">
                    <label>Initial Password</label>
                    <input type="password" id="staffPassword" value="default123">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn" style="flex: 1;">Add Staff</button>
                    <button type="button" class="btn btn-secondary" onclick="closeStaffModal()" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Classroom Modal -->
    <div id="classroomModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Classroom</h3>
                <span class="close-btn" onclick="closeClassroomModal()">&times;</span>
            </div>
            <form id="classroomForm" onsubmit="submitClassroomForm(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Room Number</label>
                        <input type="text" id="roomNumber" placeholder="e.g., A101" required>
                    </div>
                    <div class="form-group">
                        <label>Room Name</label>
                        <input type="text" id="roomName" placeholder="e.g., Lecture Hall" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Capacity</label>
                        <input type="number" id="roomCapacity" min="10" required>
                    </div>
                    <div class="form-group">
                        <label>Building</label>
                        <!-- Changed from text input to dropdown select -->
                        <select id="roomBuilding" required>
                            <option value="">Select Building</option>
                            <option value="Main Block">Main Block</option>
                            <option value="North Wing">North Wing</option>
                            <option value="South Wing">South Wing</option>
                            <option value="East Block">East Block</option>
                            <option value="West Block">West Block</option>
                            <option value="Science Block">Science Block</option>
                            <option value="Engineering Block">Engineering Block</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Floor</label>
                        <!-- Changed from text input to dropdown select -->
                        <select id="roomFloor" required>
                            <option value="">Select Floor</option>
                            <option value="Ground Floor">Ground Floor</option>
                            <option value="1st Floor">1st Floor</option>
                            <option value="2nd Floor">2nd Floor</option>
                            <option value="3rd Floor">3rd Floor</option>
                            <option value="4th Floor">4th Floor</option>
                            <option value="5th Floor">5th Floor</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Facilities (comma-separated)</label>
                    <input type="text" id="roomFacilities" placeholder="e.g., Projector, AC, Whiteboard">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn" style="flex: 1;">Add Classroom</button>
                    <button type="button" class="btn btn-secondary" onclick="closeClassroomModal()" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Timetable Modal -->
    <div id="timetableModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Class Schedule</h3>
                <span class="close-btn" onclick="closeTimetableModal()">&times;</span>
            </div>
            <form id="timetableForm" onsubmit="submitTimetableForm(event)">
                <div class="form-group">
                    <label>Staff Member</label>
                    <select id="timetableStaff" required></select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Course Code</label>
                        <input type="text" id="courseCode" required>
                    </div>
                    <div class="form-group">
                        <label>Course Name</label>
                        <input type="text" id="courseName" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Day</label>
                        <select id="classDay" required>
                            <option>Monday</option>
                            <option>Tuesday</option>
                            <option>Wednesday</option>
                            <option>Thursday</option>
                            <option>Friday</option>
                            <option>Saturday</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Time Slot</label>
                        <input type="text" id="timeSlot" placeholder="09:00-10:30" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Room</label>
                        <input type="text" id="room" required>
                    </div>
                    <div class="form-group">
                        <label>Batch (Optional)</label>
                        <input type="text" id="batch">
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn" style="flex: 1;">Add Schedule</button>
                    <button type="button" class="btn btn-secondary" onclick="closeTimetableModal()" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Override Rescheduling Modal -->
    <div id="overrideModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Override Class Assignment</h3>
                <span class="close-btn" onclick="closeOverrideModal()">&times;</span>
            </div>
            <form id="overrideForm" onsubmit="submitOverride(event)">
                <div class="form-group">
                    <label>Assign to Staff Member</label>
                    <select id="overrideStaff" required></select>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn" style="flex: 1;">Override Assignment</button>
                    <button type="button" class="btn btn-secondary" onclick="closeOverrideModal()" style="flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentReschedulingId = null;
        let allStaff = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            loadDashboardData();
            loadStaffList();
            loadClassroomList(); // Added this line
            loadTimetableList();
            loadLeaveRequests();
            loadReschedulingRecords();
            loadAttendanceReport();
            loadLoginActivity();
            setupMenuListeners();
        });

        async function checkAuth() {
            const response = await fetch('/api/session', { credentials: 'include' });
            const data = await response.json();
            if (!data.user || data.user.type !== 'admin') {
                window.location.href = 'admin-login.html';
            } else {
                document.getElementById('adminName').textContent = data.user.name;
            }
        }

        function setupMenuListeners() {
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const section = e.target.dataset.section;
                    switchSection(section);
                });
            });
        }

        function switchSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active from menu
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');
            
            // Update title
            const titles = {
                dashboard: 'Dashboard',
                staff: 'Staff Management',
                classroom: 'Classroom Management', // Added this line
                timetable: 'Timetable Management',
                'leave-approval': 'Leave Approvals',
                rescheduling: 'Class Rescheduling',
                attendance: 'Attendance & Presence',
                activity: 'Login Activity'
            };
            document.getElementById('pageTitle').textContent = titles[sectionId];
            
            // Reload data for the section
            if (sectionId === 'attendance') {
                loadAttendanceReport();
            } else if (sectionId === 'activity') {
                loadLoginActivity();
            } else if (sectionId === 'classroom') { // Added this block
                loadClassroomList();
            }
        }

        async function loadDashboardData() {
            try {
                const statsResponse = await fetch('/api/admin/stats/staff-count', { credentials: 'include' });
                const statsData = await statsResponse.json();
                document.getElementById('totalStaffCount').textContent = statsData.total_staff;
                document.getElementById('activeStaffCount').textContent = statsData.active_staff;

                const leaveResponse = await fetch('/api/admin/leave/pending', { credentials: 'include' });
                const leaveData = await leaveResponse.json();
                document.getElementById('pendingLeaveCount').textContent = leaveData.leaves.length;

                const rescheduleResponse = await fetch('/api/admin/rescheduling', { credentials: 'include' });
                const rescheduleData = await rescheduleResponse.json();
                document.getElementById('rescheduledCount').textContent = rescheduleData.records.length;

                await loadLoginActivity();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        async function loadStaffList() {
            try {
                const response = await fetch('/api/admin/staff', { credentials: 'include' });
                const data = await response.json();
                allStaff = data.staff;

                const tbody = document.getElementById('staffBody');
                tbody.innerHTML = '';
                data.staff.forEach(staff => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${staff.employee_id}</td>
                        <td>${staff.name}</td>
                        <td>${staff.email}</td>
                        <td>${staff.department}</td>
                        <td>${staff.position}</td>
                        <td>${staff.is_active ? '<span style="color: #27ae60;">Active</span>' : '<span style="color: #e74c3c;">Inactive</span>'}</td>
                        <td><button class="btn btn-danger" onclick="deactivateStaff(${staff.id})">Delete</button></td>
                    `;
                });

                // Populate timetable staff dropdown
                const staffSelect = document.getElementById('timetableStaff');
                staffSelect.innerHTML = '';
                data.staff.forEach(staff => {
                    const option = document.createElement('option');
                    option.value = staff.id;
                    option.textContent = staff.name;
                    staffSelect.appendChild(option);
                });

                // Populate override staff dropdown
                const overrideSelect = document.getElementById('overrideStaff');
                overrideSelect.innerHTML = '';
                data.staff.forEach(staff => {
                    const option = document.createElement('option');
                    option.value = staff.id;
                    option.textContent = staff.name;
                    overrideSelect.appendChild(option);
                });

                // Populate staff filter
                const staffFilter = document.getElementById('staffFilter');
                staffFilter.innerHTML = '<option value="">All Staff</option>';
                data.staff.forEach(staff => {
                    const option = document.createElement('option');
                    option.value = staff.id;
                    option.textContent = staff.name;
                    staffFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading staff:', error);
            }
        }

        function openAddClassroomModal() {
            document.getElementById('classroomModal').classList.add('active');
            document.getElementById('classroomForm').reset();
        }

        function closeClassroomModal() {
            document.getElementById('classroomModal').classList.remove('active');
        }

        async function loadClassroomList() {
            try {
                const response = await fetch('/api/admin/classrooms', { credentials: 'include' });
                const data = await response.json();

                const tbody = document.getElementById('classroomBody');
                tbody.innerHTML = '';
                data.classrooms.forEach(classroom => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${classroom.room_number}</td>
                        <td>${classroom.room_name}</td>
                        <td>${classroom.capacity}</td>
                        <td>${classroom.building || '-'}</td>
                        <td>${classroom.floor || '-'}</td>
                        <td>${classroom.facilities || '-'}</td>
                        <td>${classroom.is_active ? '<span style="color: #27ae60;">Active</span>' : '<span style="color: #e74c3c;">Inactive</span>'}</td>
                        <td><button class="btn btn-danger" onclick="deleteClassroom(${classroom.id})">Delete</button></td>
                    `;
                });
            } catch (error) {
                console.error('Error loading classrooms:', error);
            }
        }

        async function submitClassroomForm(event) {
            event.preventDefault();
            const roomNumber = document.getElementById('roomNumber').value.trim();
            const roomName = document.getElementById('roomName').value.trim();
            const capacity = document.getElementById('roomCapacity').value.trim();
            
            // Validation
            if (!roomNumber || !roomName || !capacity) {
                showMessage('classroomMessage', 'Room number, name, and capacity are required', 'error');
                return;
            }
            
            if (isNaN(capacity) || capacity < 1) {
                showMessage('classroomMessage', 'Capacity must be a positive number', 'error');
                return;
            }
            
            const formData = {
                room_number: roomNumber,
                room_name: roomName,
                capacity: capacity,
                building: document.getElementById('roomBuilding').value.trim(),
                floor: document.getElementById('roomFloor').value.trim(),
                facilities: document.getElementById('roomFacilities').value.trim()
            };

            try {
                const response = await fetch('/api/admin/classrooms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    closeClassroomModal();
                    loadClassroomList();
                    showMessage('classroomMessage', 'Classroom added successfully!', 'success');
                } else {
                    const error = await response.json();
                    showMessage('classroomMessage', error.error || 'Failed to add classroom', 'error');
                }
            } catch (error) {
                console.error('[v0] Error adding classroom:', error);
                showMessage('classroomMessage', 'Error adding classroom', 'error');
            }
        }

        async function deleteClassroom(classroomId) {
            if (confirm('Are you sure you want to delete this classroom?')) {
                try {
                    const response = await fetch(`/api/admin/classrooms/${classroomId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        loadClassroomList();
                        showMessage('classroomMessage', 'Classroom deleted successfully!', 'success');
                    } else {
                        showMessage('classroomMessage', 'Failed to delete classroom', 'error');
                    }
                } catch (error) {
                    showMessage('classroomMessage', 'Error deleting classroom', 'error');
                }
            }
        }

        async function loadTimetableList() {
            try {
                const response = await fetch('/api/admin/timetable', { credentials: 'include' });
                const data = await response.json();

                const tbody = document.getElementById('timetableBody');
                tbody.innerHTML = '';
                data.timetable.forEach(entry => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${entry.staff_name}</td>
                        <td>${entry.course_code}</td>
                        <td>${entry.course_name}</td>
                        <td>${entry.day}</td>
                        <td>${entry.time_slot}</td>
                        <td>${entry.room}</td>
                        <td>${entry.batch}</td>
                        <td><button class="btn btn-danger" onclick="deleteTimetable(${entry.id})">Delete</button></td>
                    `;
                });
            } catch (error) {
                console.error('Error loading timetable:', error);
            }
        }

        async function loadLeaveRequests() {
            try {
                const response = await fetch('/api/admin/leave/pending', { credentials: 'include' });
                const data = await response.json();

                const tbody = document.getElementById('leaveBody');
                tbody.innerHTML = '';
                data.leaves.forEach(leave => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${leave.staff_name}</td>
                        <td>${leave.leave_date}</td>
                        <td>${leave.leave_type}</td>
                        <td>${leave.reason}</td>
                        <td>${leave.applied_at}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-success" onclick="approveLeave(${leave.id})">Approve</button>
                                <button class="btn btn-danger" onclick="rejectLeave(${leave.id})">Reject</button>
                            </div>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error loading leave requests:', error);
            }
        }

        async function loadReschedulingRecords() {
            try {
                const response = await fetch('/api/admin/rescheduling', { credentials: 'include' });
                const data = await response.json();

                const tbody = document.getElementById('rescheduleBody');
                tbody.innerHTML = '';
                data.records.forEach(record => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${record.original_staff_name}</td>
                        <td>${record.assigned_staff_name}</td>
                        <td>${record.course_code} - ${record.course_name}</td>
                        <td>${record.reason}</td>
                        <td>${record.created_at}</td>
                        <td><button class="btn" onclick="openOverrideModal(${record.id})">Override</button></td>
                    `;
                });
            } catch (error) {
                console.error('Error loading rescheduling:', error);
            }
        }

        async function loadAttendanceReport() {
            try {
                const staffId = document.getElementById('staffFilter').value;
                let url = '/api/admin/leave-presence';
                if (staffId) {
                    url += `?staff_id=${staffId}`;
                }
                
                const response = await fetch(url, { credentials: 'include' });
                const data = await response.json();

                const tbody = document.getElementById('attendanceBody');
                tbody.innerHTML = '';
                data.leaves.forEach(leave => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${leave.staff_name}</td>
                        <td>${leave.leave_date}</td>
                        <td>${leave.leave_type}</td>
                        <td><span style="color: ${leave.status === 'approved' ? '#27ae60' : leave.status === 'rejected' ? '#e74c3c' : '#f39c12'};">${leave.status}</span></td>
                    `;
                });
            } catch (error) {
                console.error('Error loading attendance:', error);
            }
        }

        async function loadLoginActivity() {
            try {
                const response = await fetch('/api/admin/stats/login-activity', { credentials: 'include' });
                const data = await response.json();

                // Update dashboard activity table
                const dashboardBody = document.getElementById('activityBody');
                dashboardBody.innerHTML = '';
                data.logs.slice(0, 5).forEach(log => {
                    const row = dashboardBody.insertRow();
                    row.innerHTML = `
                        <td>${log.user_name}</td>
                        <td>${log.user_type.charAt(0).toUpperCase() + log.user_type.slice(1)}</td>
                        <td>${log.login_time}</td>
                        <td><span style="color: ${log.status === 'logged_in' ? '#27ae60' : '#e74c3c'};">${log.status}</span></td>
                    `;
                });

                // Update activity log table
                const activityBody = document.getElementById('activityLogBody');
                activityBody.innerHTML = '';
                data.logs.forEach(log => {
                    const row = activityBody.insertRow();
                    row.innerHTML = `
                        <td>${log.user_name}</td>
                        <td>${log.user_type.charAt(0).toUpperCase() + log.user_type.slice(1)}</td>
                        <td>${log.login_time}</td>
                        <td>${log.logout_time || 'Still logged in'}</td>
                        <td>${log.ip_address || '-'}</td>
                        <td><span style="color: ${log.status === 'logged_in' ? '#27ae60' : '#e74c3c'};">${log.status}</span></td>
                    `;
                });
            } catch (error) {
                console.error('Error loading login activity:', error);
            }
        }

        // Modal functions
        function openAddStaffModal() {
            document.getElementById('staffForm').reset();
            document.getElementById('staffModal').classList.add('active');
        }

        function closeStaffModal() {
            document.getElementById('staffModal').classList.remove('active');
        }

        function openAddTimetableModal() {
            document.getElementById('timetableForm').reset();
            document.getElementById('timetableModal').classList.add('active');
        }

        function closeTimetableModal() {
            document.getElementById('timetableModal').classList.remove('active');
        }

        function openOverrideModal(reschedulingId) {
            currentReschedulingId = reschedulingId;
            document.getElementById('overrideModal').classList.add('active');
        }

        function closeOverrideModal() {
            document.getElementById('overrideModal').classList.remove('active');
            currentReschedulingId = null;
        }

        // Form submissions
        async function submitStaffForm(event) {
            event.preventDefault();
            const employeeId = document.getElementById('staffEmployeeId').value.trim();
            const name = document.getElementById('staffName').value.trim();
            const email = document.getElementById('staffEmail').value.trim();
            const department = document.getElementById('staffDepartment').value.trim();
            const position = document.getElementById('staffPosition').value.trim();
            const phone = document.getElementById('staffPhone').value.trim();
            const password = document.getElementById('staffPassword').value.trim();
            
            if (!employeeId || !name || !email || !department || !position || !password) {
                showMessage('staffMessage', 'All required fields must be filled', 'error');
                return;
            }
            
            if (!email.includes('@')) {
                showMessage('staffMessage', 'Please enter a valid email address', 'error');
                return;
            }
            
            if (password.length < 6) {
                showMessage('staffMessage', 'Password must be at least 6 characters long', 'error');
                return;
            }
            
            const formData = {
                employee_id: employeeId,
                name: name,
                email: email,
                department: department,
                position: position,
                phone: phone,
                password: password
            };

            try {
                console.log('[v0] Submitting staff form with data:', formData);
                
                const response = await fetch('/api/admin/staff', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });

                const responseData = await response.json();
                console.log('[v0] Response status:', response.status);
                console.log('[v0] Response data:', responseData);

                if (response.ok) {
                    showMessage('staffMessage', 'Staff member added successfully!', 'success');
                    document.getElementById('staffForm').reset();
                    closeStaffModal();
                    // Reload staff list after 1 second to ensure data is updated
                    setTimeout(() => loadStaffList(), 1000);
                } else {
                    showMessage('staffMessage', responseData.error || 'Failed to add staff member', 'error');
                }
            } catch (error) {
                console.error('[v0] Error adding staff:', error);
                showMessage('staffMessage', 'Network error: ' + error.message, 'error');
            }
        }

        async function submitTimetableForm(event) {
            event.preventDefault();
            const staffId = document.getElementById('timetableStaff').value.trim();
            const courseCode = document.getElementById('courseCode').value.trim();
            const courseName = document.getElementById('courseName').value.trim();
            const day = document.getElementById('classDay').value.trim();
            const timeSlot = document.getElementById('timeSlot').value.trim();
            const room = document.getElementById('room').value.trim();
            
            // Validation
            if (!staffId || !courseCode || !courseName || !day || !timeSlot || !room) {
                showMessage('timetableMessage', 'All fields are required', 'error');
                return;
            }
            
            const formData = {
                staff_id: parseInt(staffId),
                course_code: courseCode,
                course_name: courseName,
                day: day,
                time_slot: timeSlot,
                room: room,
                batch: document.getElementById('batch').value.trim()
            };

            try {
                const response = await fetch('/api/admin/timetable', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    closeTimetableModal();
                    loadTimetableList();
                    showMessage('timetableMessage', 'Class schedule added successfully!', 'success');
                } else {
                    const error = await response.json();
                    showMessage('timetableMessage', error.error || 'Failed to add schedule', 'error');
                }
            } catch (error) {
                console.error('[v0] Error adding timetable:', error);
                showMessage('timetableMessage', 'Error adding class schedule', 'error');
            }
        }

        async function submitOverride(event) {
            event.preventDefault();
            const formData = {
                assigned_staff_id: parseInt(document.getElementById('overrideStaff').value)
            };

            try {
                const response = await fetch(`/api/admin/rescheduling/${currentReschedulingId}/override`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    closeOverrideModal();
                    loadReschedulingRecords();
                    showMessage('rescheduleMessage', 'Assignment overridden successfully!', 'success');
                } else {
                    showMessage('rescheduleMessage', 'Failed to override assignment', 'error');
                }
            } catch (error) {
                showMessage('rescheduleMessage', 'Error overriding assignment', 'error');
            }
        }

        async function approveLeave(leaveId) {
            try {
                const response = await fetch(`/api/admin/leave/${leaveId}/approve`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    // Auto-reschedule immediately after approval
                    await autoRescheduleLeave(leaveId);
                    loadLeaveRequests();
                    loadDashboardData();
                    showMessage('leaveMessage', 'Leave approved and classes auto-scheduled!', 'success');
                } else {
                    showMessage('leaveMessage', 'Failed to approve leave', 'error');
                }
            } catch (error) {
                showMessage('leaveMessage', 'Error approving leave', 'error');
            }
        }

        async function autoRescheduleLeave(leaveId) {
            try {
                const response = await fetch(`/api/admin/leave/${leaveId}/auto-reschedule`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    loadReschedulingRecords();
                    console.log('[v0] Auto-rescheduling completed for leave:', leaveId);
                } else {
                    console.error('[v0] Auto-rescheduling failed for leave:', leaveId);
                }
            } catch (error) {
                console.error('[v0] Error during auto-rescheduling:', error);
            }
        }

        async function rejectLeave(leaveId) {
            try {
                const response = await fetch(`/api/admin/leave/${leaveId}/reject`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    loadLeaveRequests();
                    loadDashboardData();
                    showMessage('leaveMessage', 'Leave rejected successfully!', 'success');
                } else {
                    showMessage('leaveMessage', 'Failed to reject leave', 'error');
                }
            } catch (error) {
                showMessage('leaveMessage', 'Error rejecting leave', 'error');
            }
        }

        async function deactivateStaff(staffId) {
            if (confirm('Are you sure you want to delete this staff member?')) {
                try {
                    const response = await fetch(`/api/admin/staff/${staffId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        loadStaffList();
                        showMessage('staffMessage', 'Staff member deleted successfully!', 'success');
                    } else {
                        const error = await response.json();
                        showMessage('staffMessage', error.error || 'Failed to delete staff', 'error');
                    }
                } catch (error) {
                    showMessage('staffMessage', 'Error deleting staff', 'error');
                }
            }
        }

        async function deleteTimetable(timetableId) {
            if (confirm('Are you sure you want to delete this schedule?')) {
                try {
                    const response = await fetch(`/api/admin/timetable/${timetableId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        loadTimetableList();
                        showMessage('timetableMessage', 'Schedule deleted successfully!', 'success');
                    } else {
                        showMessage('timetableMessage', 'Failed to delete schedule', 'error');
                    }
                } catch (error) {
                    showMessage('timetableMessage', 'Error deleting schedule', 'error');
                }
            }
        }

        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}-message">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 5000);
        }

        async function logout() {
            try {
                await fetch('/api/admin/logout', { 
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = 'admin-login.html';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = 'admin-login.html';
            }
        }
        
        // Load all data on page load
        window.addEventListener('load', function() {
            loadDashboardData();
            loadStaffList();
            loadClassroomList();
            loadTimetableList();
            loadLeaveRequests();
            loadReschedulingRecords();
            loadAttendanceReport(); // Renamed from loadAttendanceRecords
            loadLoginActivity();
            setInterval(loadDashboardData, 30000);
        });
    </script>
</body>
</html>
